# Implementation Plan: Security Audit SDK Migration

## Overview

Update SDK to support the security audit remediation changes in ProofSystem and JobMarketplace contracts. The primary breaking change is `submitProofOfWork()` now requires ECDSA signatures from hosts, preventing unauthorized proof submissions.

## Status: Phases 1-5 Complete, Phase 8 In Progress

**Implementation**: SDK migration for January 2026 contract upgrades
**SDK Version**: Current 1.8.2, will increment to 1.8.3 on completion
**Contract Branch**: `fix/security-audit-remediation`
**SDK Branch**: `feature/security-audit-migration`
**Network**: Base Sepolia (Chain ID: 84532)
**Source Documents**:
- `docs/compute-contracts-reference/SECURITY-AUDIT-SDK-MIGRATION.md`
- `docs/compute-contracts-reference/SDK-MIGRATION-JAN2026.md`

### Completed:
- [x] Phase 1: ABIs updated (3 files copied, fragments updated, types added)
- [x] Phase 2: ProofSigner utility created (8 tests)
- [x] Phase 3: SessionJobManager updated (7 tests)
- [x] Phase 4: Harness ProofHandler rewritten
- [x] Phase 5: Legacy code removed (none found)

### In Progress:
- [ ] Phase 8: January 2026 Contract Upgrades (ABI rename, address update)

### Pending:
- [ ] Phase 6: Integration testing with live contracts
- [ ] Phase 7: Version bump and package

---

## Summary of Contract Changes

| Change | Type | SDK Impact |
|--------|------|------------|
| `submitProofOfWork` 4→5 params | **BREAKING** | Must add signature parameter |
| Host ECDSA signature required | **BREAKING** | Must implement signing |
| New `getProofSubmission()` view | Additive | Optional integration |
| New balance view functions (4) | Additive | Optional integration |
| Removed `claimWithProof()` | **BREAKING** | Remove any usage |
| Legacy Job types/events removed | **BREAKING** | Remove any usage |

---

## Architecture: Proof Signing Flow

```
Host Node                              Smart Contract (JobMarketplace)
   ↓                                          ↓
Generate proof data                    [Upgraded with signature verification]
   ↓
proofHash = keccak256(proofData)
   ↓
dataHash = keccak256(
  proofHash + hostAddress + tokensClaimed
)
   ↓
signature = signMessage(dataHash)
   ↓                                          ↓
submitProofOfWork(                     Verify signature:
  jobId,                               ├─ ethSignedMessageHash = keccak256(
  tokensClaimed,                       │    "\x19Ethereum Signed Message:\n32" + dataHash
  proofHash,           ───────────────→│  )
  signature,                           ├─ recoveredSigner = ecrecover(hash, v, r, s)
  proofCID                             └─ require(recoveredSigner == session.host)
)                                              ↓
   ↓                                   ✅ Proof accepted OR
Receipt ←────────────────────────────  ❌ "Invalid proof signature"
```

### Key Security Properties

1. **Host Authorization**: Only the session host can submit proofs
2. **Non-repudiation**: Host cryptographically commits to token count
3. **Replay Prevention**: Each proofHash can only be used once
4. **EIP-191 Compliance**: Standard Ethereum signed message format

### Critical: Host-Side Signing

**IMPORTANT**: Proof signatures are generated by **HOSTS**, not clients.

```
Client (User Browser)              Host (LLM Node)              Contract
       ↓                                 ↓                         ↓
   Send prompt ─────────────────→ Generate response
                                        ↓
                                  Generate proofData
                                        ↓
                                  Sign with HOST wallet ←── Only host can sign!
                                        ↓
                                  submitProofOfWork() ───→ Verify signature
                                                                 ↓
                                                          recoveredSigner == session.host
```

Clients never sign proofs. The `ProofSigner` utility is for **host-side code** (fabstir-llm-node, host-cli, harness test pages acting as hosts).

### Error Messages to Handle

| Error Message | Cause | SDK Action |
|--------------|-------|------------|
| `"Invalid signature length"` | Signature not 65 bytes | Validate signature length before submission |
| `"Invalid proof signature"` | Wrong signer OR replay attack | Verify host wallet matches session.host |
| `"Host not registered"` | Host not in NodeRegistry | Check host registration before session creation |

### The `verified` Field Semantics

When querying `getProofSubmission()`:

| Value | Meaning | Action |
|-------|---------|--------|
| `verified: true` | ProofSystem validated signature successfully | Proof is cryptographically verified |
| `verified: false` | ProofSystem not configured (graceful degradation) | Proof accepted but NOT cryptographically verified |

**Note**: `verified: false` is NOT an error - it means the marketplace was deployed without a ProofSystem configured. This is allowed for backward compatibility.

### Replay Attack Constraint

**CRITICAL**: Each `proofHash` can only be used ONCE.

```typescript
// First submission - SUCCESS
await submitProofOfWork(sessionId, 100, proofHash1, sig1, cid1);

// Second submission with SAME proofHash - FAILS
await submitProofOfWork(sessionId, 100, proofHash1, sig1, cid1); // ❌ Reverts!

// Must use DIFFERENT proofData to generate new proofHash
const proofHash2 = keccak256(differentProofData);
await submitProofOfWork(sessionId, 100, proofHash2, sig2, cid2); // ✅ Works
```

The `ProofSigner` utility should generate unique proofData per submission (e.g., include timestamp or nonce in proofData).

---

## Development Approach: TDD Bounded Autonomy

1. Write ALL tests for a sub-phase FIRST
2. Show test failures before implementing
3. Implement minimally to pass tests
4. Strict line limits per file (enforced)
5. No modifications outside specified scope
6. Mark `[x]` in `[ ]` for each completed task

---

## Phase 1: Update ABIs and Type Definitions

### Sub-phase 1.1: Copy New ABI Files

**Goal**: Replace SDK ABIs with updated contract ABIs from `docs/compute-contracts-reference/client-abis/`.

**Line Budget**: 0 lines code (file copy only)

#### Tasks
- [x] Copy `docs/.../JobMarketplaceWithModelsUpgradeable-CLIENT-ABI.json` to `packages/sdk-core/src/contracts/abis/JobMarketplaceWithModelsUpgradeable-CLIENT-ABI.json`
- [x] Copy same file to `packages/sdk-core/src/contracts/abis/JobMarketplaceWithModels-CLIENT-ABI.json` (non-upgradeable version)
- [x] Copy `docs/.../ProofSystemUpgradeable-CLIENT-ABI.json` to `packages/sdk-core/src/contracts/abis/ProofSystemUpgradeable-CLIENT-ABI.json`
- [x] Verify new ABIs contain `submitProofOfWork` with 5 parameters
- [x] Verify new ABIs contain `getProofSubmission` function
- [x] Verify new ABIs contain `getLockedBalanceNative/Token` functions
- [x] Verify new ABIs contain `getTotalBalanceNative/Token` functions

**Source Files:**
- `docs/compute-contracts-reference/client-abis/JobMarketplaceWithModelsUpgradeable-CLIENT-ABI.json`
- `docs/compute-contracts-reference/client-abis/ProofSystemUpgradeable-CLIENT-ABI.json`

**Destination Files:**
- `packages/sdk-core/src/contracts/abis/JobMarketplaceWithModelsUpgradeable-CLIENT-ABI.json`
- `packages/sdk-core/src/contracts/abis/JobMarketplaceWithModels-CLIENT-ABI.json`
- `packages/sdk-core/src/contracts/abis/ProofSystemUpgradeable-CLIENT-ABI.json`

**Success Criteria:**
- [x] All 3 ABI files copied successfully
- [x] `submitProofOfWork` signature in ABI: `(uint256 jobId, uint256 tokensClaimed, bytes32 proofHash, bytes signature, string proofCID)`
- [x] New view functions present in ABI

**Status:** ✅ Complete

---

### Sub-phase 1.2: Update ABI Fragments in index.ts

**Goal**: Update the inline ABI fragments to match new contract signatures.

**Line Budget**: 10 lines (modifications only)

#### Tasks
- [x] Write test: Import `JobMarketplaceFragments.submitProofOfWork` compiles
- [x] Update `submitProofOfWork` fragment in `abis/index.ts` to new 5-param signature
- [x] Add `getProofSubmission` fragment
- [x] Add `getLockedBalanceNative` fragment
- [x] Add `getLockedBalanceToken` fragment
- [x] Add `getTotalBalanceNative` fragment
- [x] Add `getTotalBalanceToken` fragment
- [x] Verify TypeScript compilation succeeds

**Test Files:**
- `packages/sdk-core/tests/unit/abi-fragments.test.ts` (NEW, ~30 lines)

**Implementation Files:**
- `packages/sdk-core/src/contracts/abis/index.ts` (MODIFY, ~15 lines)

**Success Criteria:**
- [x] `submitProofOfWork` fragment: `'function submitProofOfWork(uint256 jobId, uint256 tokensClaimed, bytes32 proofHash, bytes signature, string proofCID)'`
- [x] All new view function fragments present
- [x] TypeScript compilation succeeds
- [x] All tests pass

**Test Results:** ✅ 7 tests passing (abi-fragments.test.ts)

---

### Sub-phase 1.3: Add Proof Type Definitions

**Goal**: Add TypeScript interfaces for proof submission and results.

**Line Budget**: 40 lines

#### Tasks
- [x] Write test: `ProofSubmissionParams` interface has all required fields
- [x] Write test: `ProofSubmissionResult` interface has all required fields
- [x] Write test: `UserBalanceInfo` interface has all required fields
- [x] Write test: `SessionStatus` enum has correct values
- [x] Create `packages/sdk-core/src/types/proof.types.ts`
- [x] Add `ProofSubmissionParams` interface
- [x] Add `ProofSubmissionResult` interface
- [x] Add `UserBalanceInfo` interface
- [x] Add `SessionStatus` enum (0-5 values)
- [x] Export types from `types/index.ts`

**Test Files:**
- `packages/sdk-core/tests/unit/proof-types.test.ts` (NEW, ~50 lines)

**Implementation Files:**
- `packages/sdk-core/src/types/proof.types.ts` (NEW, ~40 lines)
- `packages/sdk-core/src/types/index.ts` (MODIFY, +1 export)

**Success Criteria:**
- [x] All type interfaces defined correctly
- [x] SessionStatus enum: Active=0, Completed=1, TimedOut=2, Disputed=3, Abandoned=4, Cancelled=5
- [x] Types exported from SDK package
- [x] All tests pass

**Test Results:** ✅ 6 tests passing (proof-types.test.ts)

---

## Phase 2: ProofSigner Utility (Host-Side)

**IMPORTANT**: This utility is for HOST-SIDE code only. Hosts sign proofs, clients do not.

### Sub-phase 2.1: Create signProofForSubmission() Function

**Goal**: Implement the core signing function that hosts use to sign proofs.

**Line Budget**: 60 lines

#### Tasks
- [x] Write test: `signProofForSubmission()` returns correct proofHash (keccak256 of proofData)
- [x] Write test: `signProofForSubmission()` returns 65-byte signature
- [x] Write test: Signature can be verified with ecrecover to recover host address
- [x] Write test: Different tokensClaimed produces different signature
- [x] Write test: Different proofData produces different proofHash
- [x] Write test: Works with Uint8Array proofData
- [x] Write test: Works with hex string proofData
- [x] Write test: Including timestamp in proofData produces unique proofHash (replay prevention)
- [x] Create `packages/sdk-core/src/utils/ProofSigner.ts`
- [x] Import ethers: `keccak256`, `solidityPacked`, `getBytes`, `Wallet`
- [x] Define `SignedProofSubmission` interface
- [x] Implement `signProofForSubmission(proofData, hostAddress, tokensClaimed, hostWallet)`
- [x] Step 1: Generate `proofHash = keccak256(proofData)`
- [x] Step 2: Generate `dataHash = keccak256(solidityPacked([proofHash, hostAddress, tokensClaimed]))`
- [x] Step 3: Sign with `hostWallet.signMessage(getBytes(dataHash))`
- [x] Return `{ proofHash, signature }`
- [x] Add JSDoc warning: "Each proofHash can only be used once. Include timestamp/nonce in proofData."
- [x] Export from `utils/index.ts`

**Test Files:**
- `packages/sdk-core/tests/unit/proof-signer.test.ts` (NEW, ~120 lines)

**Implementation Files:**
- `packages/sdk-core/src/utils/ProofSigner.ts` (NEW, ~50 lines)
- `packages/sdk-core/src/utils/index.ts` (MODIFY, +1 export)

**Success Criteria:**
- [x] Function exported and callable
- [x] proofHash is 32 bytes (bytes32)
- [x] signature is 65 bytes (r + s + v)
- [x] Signature matches EIP-191 format (Ethereum Signed Message prefix)
- [x] All 8 tests pass

**Test Results:** ✅ Passed

---

### Sub-phase 2.2: Add Signature Verification Helper

**Goal**: Add helper to verify signatures locally before submission (optional but useful for debugging).

**Line Budget**: 30 lines

#### Tasks
- [ ] Write test: `verifyProofSignature()` returns true for valid signature
- [ ] Write test: `verifyProofSignature()` returns false for invalid signature
- [ ] Write test: `verifyProofSignature()` returns false for wrong signer
- [ ] Write test: `verifyProofSignature()` returns false for tampered tokensClaimed
- [ ] Add `verifyProofSignature(proofHash, signature, hostAddress, tokensClaimed): boolean` function
- [ ] Use `ethers.verifyMessage()` to recover signer
- [ ] Compare recovered signer with expected hostAddress
- [ ] Export from ProofSigner.ts

**Test Files:**
- `packages/sdk-core/tests/unit/proof-signer.test.ts` (EXTEND, +60 lines)

**Implementation Files:**
- `packages/sdk-core/src/utils/ProofSigner.ts` (EXTEND, +25 lines)

**Success Criteria:**
- [ ] Verification matches contract's verification logic
- [ ] Returns boolean (not throws)
- [ ] All 4 verification tests pass

**Test Results:** ✅ Passed

---

## Phase 3: Update SessionJobManager

### Sub-phase 3.1: Update submitCheckpointProof() Signature

**Goal**: Update the method to accept new parameters and call updated contract.

**Line Budget**: 50 lines (modifications)

#### Tasks
- [x] Write test: `submitCheckpointProof()` calls contract with 5 parameters
- [x] Write test: `submitCheckpointProof()` passes proofHash as bytes32
- [x] Write test: `submitCheckpointProof()` passes signature as bytes
- [x] Write test: `submitCheckpointProof()` passes proofCID as string
- [x] Write test: `submitCheckpointProof()` throws "Invalid signature length" when signature !== 65 bytes
- [x] Write test: `submitCheckpointProof()` throws "Invalid proof signature" when wrong signer
- [x] Write test: `submitCheckpointProof()` throws on replay attack (same proofHash twice)
- [x] Update method signature: remove `checkpoint`, add `proofHash`, `signature`, `proofCID`
- [x] Add signature length validation (must be 65 bytes)
- [x] Update contract call to use new parameter order
- [x] Update JSDoc with new parameter descriptions
- [x] Verify transaction waits for 3 confirmations

**Test Files:**
- `packages/sdk-core/tests/unit/session-job-manager-proof.test.ts` (NEW, ~120 lines)

**Implementation Files:**
- `packages/sdk-core/src/contracts/SessionJobManager.ts` (MODIFY, lines 231-254)

**Success Criteria:**
- [x] New signature: `submitCheckpointProof(sessionId, tokensGenerated, proofHash, signature, proofCID)`
- [x] Contract called with correct parameter types
- [x] Error handling for "Invalid signature length"
- [x] Error handling for "Invalid proof signature"
- [x] All 7 tests pass

**Test Results:** ✅ Passed

---

### Sub-phase 3.2: Update submitCheckpointProofAsHost()

**Goal**: Update the host-specific method with same changes.

**Line Budget**: 30 lines (modifications)

#### Tasks
- [x] Write test: `submitCheckpointProofAsHost()` uses hostSigner for transaction
- [x] Write test: `submitCheckpointProofAsHost()` calls contract with 5 parameters
- [x] Write test: `submitCheckpointProofAsHost()` passes correct parameter types
- [x] Update method signature to match `submitCheckpointProof()`
- [x] Update contract call
- [x] Verify hostSigner is used (not this.signer)

**Test Files:**
- `packages/sdk-core/tests/unit/session-job-manager-proof.test.ts` (EXTEND, +60 lines)

**Implementation Files:**
- `packages/sdk-core/src/contracts/SessionJobManager.ts` (MODIFY, lines 259-287)

**Success Criteria:**
- [x] Signature matches `submitCheckpointProof()`
- [x] hostSigner used for transaction
- [x] All 3 tests pass

**Test Results:** ✅ Passed

---

### Sub-phase 3.3: Add getProofSubmission() Method

**Goal**: Add method to query proof submission details from contract.

**Line Budget**: 25 lines

#### Tasks
- [x] Write test: `getProofSubmission()` returns correct ProofSubmissionResult shape
- [x] Write test: `getProofSubmission()` handles proof index 0
- [x] Write test: `getProofSubmission()` throws for non-existent proof index
- [x] Add `getProofSubmission(sessionId, proofIndex): Promise<ProofSubmissionResult>` method
- [x] Call contract's `getProofSubmission(sessionId, proofIndex)`
- [x] Map response to `ProofSubmissionResult` interface
- [x] Handle BigInt conversions

**Test Files:**
- `packages/sdk-core/tests/unit/session-job-manager-proof.test.ts` (EXTEND, +50 lines)

**Implementation Files:**
- `packages/sdk-core/src/contracts/SessionJobManager.ts` (EXTEND, +20 lines)

**Success Criteria:**
- [x] Returns `{ proofHash, tokensClaimed, timestamp, verified }`
- [x] All fields correctly typed
- [x] All 3 tests pass

**Test Results:** ✅ Passed

---

### Sub-phase 3.4: Add Balance View Methods

**Goal**: Add methods for querying locked and total balances.

**Line Budget**: 40 lines

#### Tasks
- [x] Write test: `getLockedBalanceNative()` returns bigint
- [x] Write test: `getLockedBalanceToken()` returns bigint for USDC address
- [x] Write test: `getTotalBalanceNative()` returns bigint
- [x] Write test: `getTotalBalanceToken()` returns bigint for USDC address
- [x] Add `getLockedBalanceNative(account): Promise<bigint>` method
- [x] Add `getLockedBalanceToken(account, token): Promise<bigint>` method
- [x] Add `getTotalBalanceNative(account): Promise<bigint>` method
- [x] Add `getTotalBalanceToken(account, token): Promise<bigint>` method
- [x] All methods call JobMarketplace contract

**Test Files:**
- `packages/sdk-core/tests/unit/session-job-manager-balance.test.ts` (NEW, ~80 lines)

**Implementation Files:**
- `packages/sdk-core/src/contracts/SessionJobManager.ts` (EXTEND, +35 lines)

**Success Criteria:**
- [x] All 4 balance methods return bigint
- [x] Methods use correct contract function names
- [x] All 4 tests pass

**Test Results:** ✅ Passed

---

## Phase 4: Update Harness ProofHandler (Host-Side Simulation)

**IMPORTANT**: The harness ProofHandler simulates HOST behavior for testing. In production, the fabstir-llm-node generates and signs proofs. The harness uses TEST_HOST_1 credentials to simulate this.

### Sub-phase 4.1: Rewrite generateProof() with Signing

**Goal**: Update ProofHandler to generate signed proofs instead of random bytes.

**Line Budget**: 60 lines (rewrite)

#### Tasks
- [x] Write test: `generateAndSignProof()` returns proofHash (32 bytes)
- [x] Write test: `generateAndSignProof()` returns signature (65 bytes)
- [x] Write test: `generateAndSignProof()` returns proofCID
- [x] Write test: Signature is valid for the host address
- [x] Write test: proofData includes timestamp for uniqueness (replay prevention)
- [x] Import `signProofForSubmission` from `@fabstir/sdk-core`
- [x] Rename `generateProof()` to `generateAndSignProof()`
- [x] Update interface to include `proofCID` parameter
- [x] Generate proofData from model + input + output hashes + timestamp (128 bytes)
- [x] Call `signProofForSubmission()` with host wallet
- [x] Return `{ proofHash, signature, proofCID }`

**Test Files:**
- `apps/harness/tests/proof-handler.test.ts` (NEW, ~100 lines)

**Implementation Files:**
- `apps/harness/lib/proof-handler.ts` (REWRITE, ~60 lines)

**Success Criteria:**
- [x] No more `ethers.randomBytes()` usage
- [x] Real ECDSA signatures generated
- [x] proofData includes timestamp for replay prevention
- [x] All 5 tests pass

**Test Results:** ✅ Passed

---

### Sub-phase 4.2: Update submitProof() Method

**Goal**: Update submission to use new contract signature.

**Line Budget**: 30 lines (modifications)

#### Tasks
- [x] Write test: `submitProof()` calls contract with 5 parameters
- [x] Write test: `submitProof()` returns ProofStatus on success
- [x] Write test: `submitProof()` throws on "Invalid proof signature" error
- [x] Update method signature: `submitProof(jobId, proofHash, signature, tokensProven, proofCID)`
- [x] Update ABI string to new signature
- [x] Update contract call parameter order
- [x] Handle new error messages

**Test Files:**
- `apps/harness/tests/proof-handler.test.ts` (EXTEND, +60 lines)

**Implementation Files:**
- `apps/harness/lib/proof-handler.ts` (MODIFY, ~25 lines)

**Success Criteria:**
- [x] Contract called with: `(jobId, tokensClaimed, proofHash, signature, proofCID)`
- [x] Error handling for "Invalid proof signature"
- [x] All 3 tests pass

**Test Results:** ✅ Passed

---

## Phase 5: Remove Legacy Code

### Sub-phase 5.1: Search and Remove Legacy References

**Goal**: Remove any references to removed contract functions/types.

**Line Budget**: Negative (deletions only)

#### Tasks
- [x] Run: `grep -r "claimWithProof" --include="*.ts" packages/sdk-core/src`
- [x] Remove any `claimWithProof()` function calls (none found)
- [x] Run: `grep -r "JobPosted\|JobClaimed\|JobCompleted" --include="*.ts" packages/sdk-core/src`
- [x] Remove any legacy Job event listeners (none found)
- [x] Verify SDK `JobType` enum in `transcode.types.ts` is kept (different from contract enum)
- [x] Run build to verify no broken imports

**Implementation Files:**
- Various files in `packages/sdk-core/src/` (MODIFY, deletions only)

**Success Criteria:**
- [x] No references to `claimWithProof()`
- [x] No references to legacy Job events
- [x] SDK `JobType` enum preserved for transcode functionality
- [x] Build succeeds

**Test Results:** ✅ Passed

---

## Phase 6: Integration Testing

### Sub-phase 6.1: Unit Test Suite

**Goal**: Ensure all unit tests pass.

**Line Budget**: 0 lines (verification only)

#### Tasks
- [x] Run `cd packages/sdk-core && pnpm build`
- [x] Verify build succeeds without errors
- [x] Run `cd packages/sdk-core && pnpm test`
- [x] Verify all proof-related unit tests pass (28/28)
- [x] Check for TypeScript errors (pre-existing only, none related to migration)

**Success Criteria:**
- [x] Build completes successfully
- [x] All new tests pass (28 tests passing)
- [x] No TypeScript errors in modified files (pre-existing errors unrelated)

**Test Results:** ✅ Passed

---

### Sub-phase 6.2: Contract Integration Test

**Goal**: Test proof submission against live Base Sepolia contracts.

**Line Budget**: 150 lines (new test file)

#### Tasks
- [ ] Write test: Submit proof with valid signature succeeds
- [ ] Write test: Submit proof with invalid signature fails with "Invalid proof signature"
- [ ] Write test: Submit proof with wrong host wallet fails
- [ ] Write test: Submit proof with invalid signature length fails with "Invalid signature length"
- [ ] Write test: Replay attack (same proofHash twice) fails
- [ ] Write test: Query `getProofSubmission()` returns correct data with verified=true
- [ ] Write test: Query balance functions return expected values
- [ ] Write test: Session creation with unregistered host fails with "Host not registered"
- [ ] Create `packages/sdk-core/tests/integration/proof-submission.test.ts`
- [ ] Use TEST_HOST_1 credentials from `.env.test`
- [ ] Create real session before proof submission
- [ ] Verify all test scenarios

**Test Files:**
- `packages/sdk-core/tests/integration/proof-submission.test.ts` (NEW, ~200 lines)

**Implementation Files:**
- None (test only)

**Success Criteria:**
- [ ] Valid signature proof submission succeeds
- [ ] Invalid signature properly rejected with correct error message
- [ ] Invalid signature length properly rejected
- [ ] Replay attack properly rejected
- [ ] `verified` field correctly reflects ProofSystem validation
- [ ] All 8 integration tests pass

**Test Results:** ✅ Passed

---

## Phase 7: Build and Package

### Sub-phase 7.1: Final Build and Verification

**Goal**: Create final SDK build and verify.

**Line Budget**: 0 lines (verification only)

#### Tasks
- [ ] Update `packages/sdk-core/package.json` version (increment patch/minor)
- [ ] Run `cd packages/sdk-core && pnpm build`
- [ ] Run `cd packages/sdk-core && pnpm test`
- [ ] Run `cd packages/sdk-core && pnpm pack`
- [ ] Verify tarball created
- [ ] Copy tarball to workspace root

**Success Criteria:**
- [ ] SDK version incremented
- [ ] Build succeeds
- [ ] All tests pass
- [ ] Tarball created and accessible

**Test Results:** ✅ Passed

---

## Files Changed Summary

| File | Phase | Action | Lines |
|------|-------|--------|-------|
| `src/contracts/abis/JobMarketplaceWithModels*.json` | 1.1 | Replace | ~1100 |
| `src/contracts/abis/ProofSystemUpgradeable-CLIENT-ABI.json` | 1.1 | Replace | ~550 |
| `src/contracts/abis/index.ts` | 1.2 | Modify | +15 |
| `src/types/proof.types.ts` | 1.3 | New | +40 |
| `src/types/index.ts` | 1.3 | Modify | +1 |
| `src/utils/ProofSigner.ts` | 2.1-2.2 | New | +75 |
| `src/utils/index.ts` | 2.1 | Modify | +1 |
| `src/contracts/SessionJobManager.ts` | 3.1-3.4 | Modify | +80 |
| `apps/harness/lib/proof-handler.ts` | 4.1-4.2 | Rewrite | ~80 |
| **Total New Code** | | | **~290** |

---

## Test Coverage Target

| Test File | Tests | Status |
|-----------|-------|--------|
| `abi-fragments.test.ts` | 3 | ⏳ Pending |
| `proof-types.test.ts` | 4 | ⏳ Pending |
| `proof-signer.test.ts` | 12 | ⏳ Pending |
| `session-job-manager-proof.test.ts` | 13 | ⏳ Pending |
| `session-job-manager-balance.test.ts` | 4 | ⏳ Pending |
| `proof-handler.test.ts` (harness) | 8 | ⏳ Pending |
| `proof-submission.test.ts` (integration) | 8 | ⏳ Pending |
| **Total** | **52** | ⏳ **0/52** |

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Signature format mismatch | Use identical signing logic from migration guide |
| Contract revert on invalid signature | Add verification helper to check before submission |
| Breaking existing proof flows | Comprehensive test coverage before deployment |
| ABI out of sync with contract | Copy ABIs directly from docs/compute-contracts-reference/client-abis/ |
| Legacy code still referenced | Grep search and remove before build |

---

## Contract Addresses (Unchanged)

```typescript
const CONTRACTS = {
  jobMarketplace: "0xeebEEbc9BCD35e81B06885b63f980FeC71d56e2D",  // Proxy
  nodeRegistry: "0x8BC0Af4aAa2dfb99699B1A24bA85E507de10Fd22",    // Proxy
  modelRegistry: "0x1a9d91521c85bD252Ac848806Ff5096bBb9ACDb2",   // Proxy
  proofSystem: "0x5afB91977e69Cc5003288849059bc62d47E7deeb",     // Proxy
  hostEarnings: "0xE4F33e9e132E60fc3477509f99b9E1340b91Aee0",    // Proxy
  fabToken: "0xC78949004B4EB6dEf2D66e49Cd81231472612D62",
  usdcToken: "0x036CbD53842c5426634e7929541eC2318f3dCF7e"
};
```

**Note**: Proxy addresses remain unchanged. Only implementation contracts were upgraded.

---

## Phase 8: January 2026 Contract Upgrades

**Date Added:** January 9, 2026
**Status:** Not Started
**Source Document:** `docs/compute-contracts-reference/SDK-MIGRATION-JAN2026.md`

### Summary of Changes

| Change | Old | New | SDK Impact |
|--------|-----|-----|------------|
| JobMarketplace Proxy | `0xeebEEbc9BCD35e81B06885b63f980FeC71d56e2D` | `0x3CaCbf3f448B420918A93a88706B26Ab27a3523E` | Environment config |
| ProofSystem function | `verifyEKZL` | `verifyHostSignature` | ABI update |
| Solidity version | 0.8.x | 0.8.30 | No SDK changes |
| ReentrancyGuard | Standard | Transient (EIP-1153) | No SDK changes (~4900 gas savings) |

### Sub-phase 8.1: ProofSystem ABI Updates (SDK Core)

**Goal:** Update ProofSystem ABIs to use renamed function `verifyHostSignature`.

**Files to modify:**
- `packages/sdk-core/src/contracts/abis/ProofSystemUpgradeable-CLIENT-ABI.json`
- `packages/sdk-core/src/contracts/abis/ProofSystem-CLIENT-ABI.json`

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.1.1 | Write test: ABI contains `verifyHostSignature` function | [x] |
| 8.1.2 | Write test: ABI does NOT contain `verifyEKZL` function | [x] |
| 8.1.3 | Update `ProofSystemUpgradeable-CLIENT-ABI.json`: rename `verifyEKZL` → `verifyHostSignature` | [x] |
| 8.1.4 | Update `ProofSystem-CLIENT-ABI.json`: rename `verifyEKZL` → `verifyHostSignature` | [x] |
| 8.1.5 | Run tests to verify ABI changes | [x] |

**Test file:** `packages/sdk-core/tests/contracts/proof-system-abi.test.ts`

**Test Results:** ✅ 6/6 tests passing

**Acceptance criteria:**
- [x] ABI contains `verifyHostSignature` function
- [x] ABI does NOT contain `verifyEKZL` function
- [ ] SDK builds successfully after changes (verified in 8.5)

---

### Sub-phase 8.2: ProofSystem ABI Updates (Host CLI)

**Goal:** Update ProofSystem ABI in host-cli package.

**Files to modify:**
- `packages/host-cli/src/contracts/abis/ProofSystem.json`

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.2.1 | Update `ProofSystem.json`: rename `verifyEKZL` → `verifyHostSignature` | [x] |
| 8.2.2 | Verify host-cli builds successfully | [x] |

**Note:** Build has pre-existing TS error in `staking.ts` (unrelated to ABI change). ABI update verified by grep search.

**Acceptance criteria:**
- [x] No references to `verifyEKZL` in host-cli package
- [ ] Host CLI builds without errors (blocked by pre-existing issue)

---

### Sub-phase 8.3: ProofSystem ABI Updates (Legacy)

**Goal:** Update legacy ProofSystem ABI for consistency.

**Files to modify:**
- `src/contracts/abis/ProofSystem-CLIENT-ABI.json`

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.3.1 | Update legacy `ProofSystem-CLIENT-ABI.json`: rename `verifyEKZL` → `verifyHostSignature` | [ ] |

**Note:** This is deprecated code but should be updated for consistency.

---

### Sub-phase 8.4: Contract Address Configuration

**Goal:** Update environment configuration with new JobMarketplace proxy address.

**CRITICAL:** `.env.test` can ONLY be modified by the project owner.

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.4.1 | **[USER ACTION]** Update `.env.test`: `CONTRACT_JOB_MARKETPLACE=0x3CaCbf3f448B420918A93a88706B26Ab27a3523E` | [ ] |
| 8.4.2 | Write test: SDK loads correct JobMarketplace address from environment | [ ] |
| 8.4.3 | Run address verification test | [ ] |

**Test file:** `packages/sdk-core/tests/config/contract-addresses.test.ts`

**New addresses:**
```
CONTRACT_JOB_MARKETPLACE=0x3CaCbf3f448B420918A93a88706B26Ab27a3523E  # NEW - Clean slate
CONTRACT_NODE_REGISTRY=0x8BC0Af4aAa2dfb99699B1A24bA85E507de10Fd22    # Unchanged
CONTRACT_MODEL_REGISTRY=0x1a9d91521c85bD252Ac848806Ff5096bBb9ACDb2   # Unchanged
CONTRACT_PROOF_SYSTEM=0x5afB91977e69Cc5003288849059bc62d47E7deeb     # Unchanged
CONTRACT_HOST_EARNINGS=0xE4F33e9e132E60fc3477509f99b9E1340b91Aee0    # Unchanged
```

---

### Sub-phase 8.5: Build Verification

**Goal:** Ensure SDK builds and existing tests pass after all changes.

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.5.1 | Run `pnpm build` in `packages/sdk-core` | [ ] |
| 8.5.2 | Run `pnpm build` in `packages/host-cli` | [ ] |
| 8.5.3 | Run existing unit tests | [ ] |
| 8.5.4 | Verify no `verifyEKZL` references remain (excluding docs) | [ ] |

**Verification command:**
```bash
grep -r "verifyEKZL" --include="*.ts" --include="*.json" packages/ src/ --exclude-dir=node_modules | grep -v "\.md"
```

---

### Sub-phase 8.6: Integration Verification

**Goal:** Test SDK against new contract deployment on Base Sepolia.

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.6.1 | Test session creation with new JobMarketplace proxy | [ ] |
| 8.6.2 | Test proof submission with ECDSA signature | [ ] |
| 8.6.3 | Test `verifyHostSignature` via ProofSystem (if SDK calls directly) | [ ] |
| 8.6.4 | Test session completion flow | [ ] |
| 8.6.5 | Test balance query functions | [ ] |

**Test harness:** `apps/harness/pages/usdc-mvp-flow-sdk.test.tsx`

---

### Sub-phase 8.7: Version Bump and Package

**Goal:** Create final SDK build with version increment.

**Tasks:**

| Task | Description | Status |
|------|-------------|--------|
| 8.7.1 | Update `packages/sdk-core/package.json` version to 1.8.3 | [ ] |
| 8.7.2 | Run final build | [ ] |
| 8.7.3 | Run all tests | [ ] |
| 8.7.4 | Create tarball with `pnpm pack` | [ ] |

---

## Phase 8 Progress Summary

| Sub-phase | Description | Status | Tasks |
|-----------|-------------|--------|-------|
| 8.1 | SDK Core ProofSystem ABIs | ✅ Complete | 5/5 |
| 8.2 | Host CLI ProofSystem ABI | ✅ Complete | 2/2 |
| 8.3 | Legacy ProofSystem ABI | Not Started | 0/1 |
| 8.4 | Contract Address Config | Not Started | 0/3 |
| 8.5 | Build Verification | Not Started | 0/4 |
| 8.6 | Integration Verification | Not Started | 0/5 |
| 8.7 | Version Bump & Package | Not Started | 0/4 |
| **Total** | | | **7/24** |

---

## Not In Scope (Future Work)

- Automatic retry on signature verification failure
- Batch proof submission support
- Proof caching/deduplication
- Gas estimation for proof submission
- UI components for proof status display
- ProofSystem circuit registration
