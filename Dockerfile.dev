FROM fabstir-llm-sdk-dev-cdp:latest

# Switch to root to install system packages
USER root

# --- Base system packages ---
RUN apt-get update && apt-get install -y \
    git curl build-essential python3 \
    # Extra deps for Chrome/Playwright
    xvfb libgtk-3-0 libnss3 libxss1 libasound2 \
    libatk1.0-0 libatk-bridge2.0-0 libdrm2 libgbm1 libxshmfence1 \
    wget \
    && rm -rf /var/lib/apt/lists/*

# --- Global Node tools for SDK dev ---
RUN npm install -g pnpm typescript ts-node vitest

# --- Install Playwright + Chromium ---
RUN npm install -g playwright \
    && npx playwright install --with-deps

WORKDIR /workspace

# Copy entrypoint script
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
RUN mkdir -p /tmp/.X11-unix && chmod 1777 /tmp/.X11-unix

# --- Ensure developer has sudo ---
RUN id -u developer >/dev/null 2>&1 || useradd -m -s /bin/bash developer && \
    echo "developer ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# --- Fix node_modules permissions for developer ---
RUN mkdir -p /workspace/node_modules && chown -R developer:developer /workspace/node_modules
RUN mkdir -p /tmp/.X11-unix && chmod 1777 /tmp/.X11-unix

WORKDIR /workspace

USER developer

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]

